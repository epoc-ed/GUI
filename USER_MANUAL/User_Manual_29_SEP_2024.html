<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>User Manual</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">User Manual</h1>
</header>
<h1 id="new-receiver-and-viewer-of-jungfrau-for-ed-ccsa-uniwien">New
Receiver and Viewer of JUNGFRAU for ED, CCSA-UniWien</h1>
<p>Latest update: on 29 Sep 2024 by KT - <a
href="#Activation">Activation</a> - <a
href="#Deactivation">Deactivation</a> - <a href="#Main-Function">Main
Function</a> - <a href="#TEM-control-Function">TEM-control Function</a>
- <a href="#Data-recording-workflow">Data-recording workflow</a> - <a
href="#Data-recording-workflow-with-Testing-version">Data-recording
workflow with Testing version</a> - <a
href="#Data-processing-notes,-6-7-Jun-2024">Data-procesing notes</a> -
<a href="#Troubleshooting">Troubleshooting</a></p>
<h3 id="activation">Activation</h3>
<p><strong>*TEM-PC, NOT needed when you ONLY use the TEM console
panel</strong> 1. Activate the TEM server - log-in with user ‘JEM User’.
- From the Windows Start Menu, open a Miniconda Powershell Prompt
(Anaconda submenu). - Change directory to C: - Type
<code>$ conda activate vjem38</code> - Type
<code>$ python server_tem.py</code> This must be done
<strong>before</strong> starting the GUI below.</p>
<p><strong>*CameraPC (hodgkin)</strong> 1. When we login as ‘psi’, the
environment has been setup. 1. Check the JF status with
<code>$ g status</code> 1. If the JF is not configurated,
<code>$ p config ~/jf.config</code> and start it with
<code>$ p start</code> 1. If the configuration is ready, just start the
JF with <code>$ p start</code> 1.
<code>$ cd /home/psi/software/v2/reuss/build</code> 1.
<code>$ ./srecv -t 12</code><br />
<em>*Using 12 threads</em><br />
<strong><em>*Do not use another one at
/home/psi/software/v2/python/app/srecv</em></strong> 1.
<code>$ cd /home/psi/software/viewer_2.0/GUI</code>
<!-- *\*'testing' version will be renamed as 'stable' version after the bug-fix* -->
1. <code>$ git switch testing</code> (or
<code>$ git checkout testing</code>) 1.
<code>$ git branch --contains</code><br />
<em>Confirm you are under the ‘testing’ branch.</em> 1.
<code>$ python launch_gui.py</code><br />
<em>*To use TEM control functions,
<code>$ python launch_gui.py -t</code></em> 1. Start streaming in the
GUI, without incident beam. 1.
<code>&gt;&gt;&gt; r.record_pedestal(1)</code> <em>at the terminal
window where the receiver (srecv) is running<br />
</em><strong><em>*To be more careful of the threshold, reset the value
before pedestaling as: <code>r.set_threshold(-50)</code></em></strong>*
1. [optional] <code>&gt;&gt;&gt; r.record_pedestal(2)</code> 1.
[optional] ‘Acquisition Interval (ms)’ in GUI could be changed to ‘20’
to reduce the dealy. A flow of error messages generated can be
ignored.</p>
<h3 id="deactivation">Deactivation</h3>
<p><strong>*CameraPC (hodgkin)</strong> 1. Stop streaming and Exit the
viewer 1. Stop the receiver from the terminal window. This may take
several tens of seconds.<br />
<code>&gt;&gt;&gt; r.stop()</code> 1. <code>$ p stop</code></p>
<p><strong>*TEM-PC</strong> 1. Open another PowerShell console and kill
the corresponding python process<br />
<code>$ Get-Process python</code><br />
<code>$ kill [process-id]</code></p>
<hr />
<h4
id="information-below-is-for-versions-up-to-the-end-of-july-2024."><strong>Information
below is for versions up to the end of July 2024.</strong></h4>
<h3 id="main-function">Main Function</h3>
<ul>
<li>‘View Stream’: Reads the stream of frames sent by the receiver.</li>
<li>‘Auto Contrast’: Dynamically adjusts the contrast of the displayed
frames.</li>
<li>‘Exit’: Exits the GUI. The connection to TEM is disconnected before
exiting.</li>
<li><a href="screenshot/ver_21Jun2024.png">‘[A]’</a> at the bottom left
of the viewer panel can reset the viewer scale.</li>
<li>‘Beam Gaussian Fit’: Starts the gaussian fitting of the beam
elliptical spot shape.
<ul>
<li><em>only at non-tem mode. at the moment, useful as a quantifying
indicator for manual-focusing.</em></li>
</ul></li>
<li>‘Magnification’, ‘Distance’: Indicates magnification/distance value
obtained at the previous recoring
<!--      - 'scale' for displaying a scale bar for imaging (1 um length) or the Debye-ring for diffraction (1 A circle) -->
<ul>
<li><em>only at tem mode.</em></li>
</ul></li>
<li>‘Accumulate in TIFF’: Save a tiff-snapshot at the defined data path
in lineedit.</li>
<li>‘Write Stream in H5’: Save an hdf-movie at the defined data path
with prefix in lineedits. The output file ends with ’_master.h5’.</li>
</ul>
<h4 id="tem-control-function"><em><a
href="screenshot/ver_16Aug2024.PNG">TEM-control Function</a></em></h4>
<ul>
<li>‘Connect to TEM’: (deactivated) Starts communication with TEM.</li>
<li>‘Get TEM status’: (deactivated) Updates the TEM information and
shows in the terminal. If an hdf file with the defined filename exists,
the information will be added to the header.
<ul>
<li>‘recording’: (deactivated) save the TEM values in the log file in
the current directory.</li>
</ul></li>
<li>‘Click-on-Centring’: (deactivated) Activates stage control by
clicking the streaming image</li>
<li>‘Beam Autofocus’: (<strong>! Not ready for use!</strong>) Sweeps IL1
and ILstig values linearly, roughly and finely</li>
<li>‘Rotation’: Starts stage rotation until the input tilt degree (in
the lower box, ‘Target angle’), and reports the setting parameters. When
the beam is blanked, it will be unblanked on starting the rotation. When
the rotation ends, the beam will be blanked. The rotation can be
interrupted either by clicking this button again or touching the tilt
button of the TEM console.<br />
<em>‘Start angle’ only indicates the current value (not real-time) and
can not be modified.’</em>
<ul>
<li>‘with Writer’: The HDF writer (‘Write Stream in H5’) is synchronized
with the rotation.</li>
<li>‘Auto reset’: The stage tilt will be reset to 0 deg after the
rotation.</li>
<li>‘Rotation Speed’: Changes rotation speed settings and indicates the
current value.<br />
<strong>The rotation speed buttion should be clicked right before
starting rotation. <a
href="https://github.com/epoc-ed/GUI/issues/37">This will be
fixed.</a></strong></li>
</ul></li>
<li>‘Stage Ctrl’: Moves the stage quickly by a constant values.</li>
</ul>
<hr />
<h3 id="data-recording-workflow">Data-recording workflow</h3>
<!-- , 21 May 2024 -->
<ol type="1">
<li>Setup the beam and stage of TEM for data collection.</li>
<li>Define the data output path on the ‘H5 Output Path’ lineedit via a
folder icon.</li>
<li>Start the stage rotation of TEM for example, and immediately click
‘Write Stream in H5’</li>
<li>Click ‘Stop Writing’ right before the rotation ends.
<!-- 1. When 'Prepare for XDS processing' is checked, the ouput filename is end with '_master.h5' -->
<!-- 1. Modify the 'Acquisition Interval (ms)' --></li>
</ol>
<hr />
<h3 id="data-recording-workflow-with-testing-version--t">Data-recording
workflow with Testing version (<em>‘-t’</em>)</h3>
<ol type="1">
<li>Setup the beam and stage of TEM for data collection.</li>
<li>Blank the beam to avoid the sample damage.</li>
<li>Confirm/modify the data output path on the ‘H5 Output Path’
line-edit via a folder icon or manually (but cannot create an inexistent
folder).</li>
<li>Confirm/modify the stage rotation speed and the end angle of the
rotation.</li>
<li>Check the ‘with Writer’ box. Check/uncheck the ‘Auto reset’
box.</li>
<li>Click ‘Rotation’ button, then start the rotation and recording
synchronously.</li>
<li>The rotation/recording continues until reaching the end angle or
being interrupted.</li>
<li>Take a tiff image if you need. The tiff image is not tied with the
HDF file at the moment.</li>
</ol>
<!-- ***
### Data-recording workflow with Development version, 4 Jul 2024
1. Setup the beam and stage of TEM for data collection.
1. Define the data output path on the 'H5 Output Path' lineedit. *a '/' at the last part of the path may cause an error.
1. Check 'Write during rotaion'
1. Define the end angle
1. Click 'Rotation/Record' to start the rotation and recording.
1. Rotation/recording can be stopped by clicking 'Stop' (the same button) or interrupption by TEM console. Otherwise the recording will continue until tilted to the end angle.
*\*The frame rate in recording is 50 ms and independent from the value at 'Aquisition Interval'. At this rate, recording with 1 deg/s means 0.05 deg/frame.*
*\*TEM information will be written in the HDF when 'Write during rotaion' is checked.* -->
<hr />
<h3 id="data-processing-notes-6-7-jun-2024">Data-processing notes, 6-7
Jun 2024</h3>
<ul>
<li>Read with XDS:<br />
The plugin derived from Neggia one requires ’_master.h5’ in the input
filename, and a symbolic link with the suffix should be additionally
prepared (to be corrected).<br />
<code>[working-directory]$ ln -s [full-path of hdffile] linked_master.h5</code></li>
<li>Read with DIALS:<br />
<a
href="https://github.com/epoc-ed/DataProcessing/blob/main/DIALS/format/FormatHDFJungfrauVIE02.py">An
updated Format Class</a> must be installed. Then DIALS can read the HDF
directly;<br />
<code>dials.import [filename.h5] slow_fast_beam_center=257,515 distance=660</code></li>
</ul>
<!--
#### Data-processing workflow, 21 May 2024
*\* The complete feasibility (including structure refinement) of the new data has not been established yet on 28th May 2024*
- Read with DIALS:\
    When the Format Class [https://github.com/epoc-ed/DataProcessing/blob/main/DIALS/format/FormatHDFJungfrauVIE01.py] is installed, DIALS can read the HDF directly;\
    ```dials.import ******_master.h5```
- Read with XDS:\
    XDS can read the HDF file with a plugin command 'LIB= [plugin_path]'. A modified Neggia plugin [https://github.com/epoc-ed/DataProcessing/tree/main/XDS/neggia/src/dectris/neggia/plugin] can be used.\
-->
<hr />
<h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li>The PowerShell console does not recover after disconnecting to the
GUI.<br />
<em>Open another PowerShell console and kill the corresponding python
process</em><br />
<code>$ Get-Process python</code><br />
<code>$ kill [pid]</code></li>
<li><strong>[Fixed]</strong> Hdf files are not output to the defined
path.<br />
<em>Modity the H5 Output Path via the folder icon (activates
file-browser system).</em></li>
<li>The TEM-control button does not respond immediately.<br />
<em>There will be a delay of a few seconds in responding, especially the
first time. Please wait a few moments.</em></li>
</ul>
</body>
</html>
